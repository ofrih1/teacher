<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>מערכת ניהול שיעורים</title>
  <style>
    :root {
      --primary-color: #4CAF50;
      --secondary-color: #2196F3;
      --danger-color: #f44336;
      --warning-color: #FF9800;
      --success-color: #4CAF50;
      --bg-color: #f2f2f2;
      --card-bg: white;
      --text-color: #333;
      --border-color: #ccc;
    }

    [data-theme="dark"] {
      --bg-color: #1a1a1a;
      --card-bg: #2d2d2d;
      --text-color: #fff;
      --border-color: #555;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: var(--bg-color);
      color: var(--text-color);
      direction: rtl;
      transition: all 0.3s ease;
    }

    nav {
      background: var(--primary-color);
      color: white;
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 15px 10px;
      position: relative;
    }

    nav button {
      background: transparent;
      border: none;
      color: white;
      font-size: 16px;
      cursor: pointer;
      padding: 8px 16px;
      border-radius: 5px;
      transition: background 0.3s ease;
    }

    nav button:hover {
      background: rgba(255,255,255,0.2);
    }

    .theme-toggle {
      position: absolute;
      left: 20px;
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
    }

    .tab {
      display: none;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .tab.active {
      display: block;
    }

    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      text-align: center;
    }

    .stat-number {
      font-size: 2em;
      font-weight: bold;
      color: var(--primary-color);
    }

    .form-section {
      background: var(--card-bg);
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }

    input, select, textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: 5px;
      background: var(--card-bg);
      color: var(--text-color);
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--secondary-color);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--card-bg);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    th, td {
      padding: 10px;
      text-align: right;
      border-bottom: 1px solid var(--border-color);
    }

    th {
      background: var(--primary-color);
      color: white;
      font-weight: 600;
    }

    tr:hover {
      background: rgba(76, 175, 80, 0.1);
    }

    .btn {
      padding: 6px 12px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      margin: 2px;
      transition: all 0.3s ease;
    }

    .btn:hover {
      opacity: 0.8;
    }

    .btn-primary { background: var(--secondary-color); color: white; }
    .btn-success { background: var(--success-color); color: white; }
    .btn-warning { background: var(--warning-color); color: white; }
    .btn-danger { background: var(--danger-color); color: white; }
    .btn-secondary { background: #6c757d; color: white; }

    .paid { background-color: rgba(76, 175, 80, 0.1); }
    .unpaid { background-color: rgba(244, 67, 54, 0.1); }
    .overdue { background-color: rgba(255, 152, 0, 0.2); }

    .search-filter {
      background: var(--card-bg);
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .progress-bar {
      width: 100%;
      height: 20px;
      background-color: #e0e0e0;
      border-radius: 10px;
      overflow: hidden;
      margin: 10px 0;
    }

    .progress-fill {
      height: 100%;
      background: var(--success-color);
      transition: width 0.3s ease;
    }

    .rating {
      display: inline-block;
    }

    .rating span {
      color: #ffa500;
      font-size: 16px;
    }

    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
      background: var(--border-color);
      border-radius: 10px;
      overflow: hidden;
    }

    .calendar-day {
      background: var(--card-bg);
      padding: 8px;
      min-height: 60px;
      position: relative;
      font-size: 12px;
    }

    .calendar-lesson {
      background: var(--primary-color);
      color: white;
      padding: 2px 4px;
      border-radius: 3px;
      font-size: 10px;
      margin: 1px 0;
      cursor: pointer;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 5px;
      color: white;
      z-index: 1001;
      transform: translateX(400px);
      transition: transform 0.3s ease;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success { background: var(--success-color); }
    .notification.error { background: var(--danger-color); }
    .notification.warning { background: var(--warning-color); }

    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .dashboard {
        grid-template-columns: 1fr;
      }
      
      nav {
        flex-wrap: wrap;
      }
    }
  </style>
</head>
<body data-theme="light">

<nav>
  <button class="theme-toggle" onclick="toggleTheme()">🌓</button>
  <button onclick="showTab('dashboard')">דשבורד</button>
  <button onclick="showTab('students')">ניהול תלמידים</button>
  <button onclick="showTab('lessons')">מעקב שיעורים</button>
  <button onclick="showTab('calendar')">יומן</button>
  <button onclick="showTab('payments')">תשלומים</button>
  <button onclick="showTab('reports')">דוחות</button>
</nav>

<!-- דשבורד -->
<div id="dashboard" class="tab active">
  <h2>דשבורד ראשי</h2>
  <div class="dashboard" id="dashboardStats"></div>
  
  <div class="form-section">
    <h3>פעילות אחרונה</h3>
    <div id="recentActivity"></div>
  </div>
</div>

<!-- ניהול תלמידים -->
<div id="students" class="tab">
  <div class="search-filter">
    <input type="text" id="studentSearch" placeholder="חפש תלמיד..." onkeyup="filterStudents()">
  </div>
  
  <div class="form-section">
    <h3>הוסף/ערוך תלמיד</h3>
    <div class="form-row">
      <div>
        <label>שם תלמיד:</label>
        <input type="text" id="studentName">
      </div>
      <div>
        <label>גיל:</label>
        <input type="number" id="studentAge">
      </div>
      <div>
        <label>כיתה:</label>
        <input type="text" id="studentClass">
      </div>
    </div>
    <div class="form-row">
      <div>
        <label>מחיר שיעור (ברירת מחדל):</label>
        <input type="number" id="studentPrice" value="100">
      </div>
      <div>
        <label>אחוז הנחה:</label>
        <input type="number" id="studentDiscount" value="0" min="0" max="100">
      </div>
      <div>
        <label>טלפון:</label>
        <input type="tel" id="studentPhone">
      </div>
    </div>
    <button class="btn btn-success" onclick="addStudent()">שמור</button>
    <button class="btn btn-warning" onclick="cancelStudentEdit()" id="cancelStudentBtn" style="display:none;">ביטול</button>
  </div>
  
  <div class="form-section">
    <table id="studentTable"></table>
  </div>
</div>

<!-- מעקב שיעורים -->
<div id="lessons" class="tab">
  <div class="search-filter">
    <div class="form-row">
      <div>
        <input type="text" id="lessonSearch" placeholder="חפש שיעור..." onkeyup="filterLessons()">
      </div>
      <div>
        <select id="lessonFilter" onchange="filterLessons()">
          <option value="">כל השיעורים</option>
          <option value="paid">שולמו</option>
          <option value="unpaid">לא שולמו</option>
          <option value="overdue">באיחור</option>
        </select>
      </div>
    </div>
  </div>
  
  <div class="form-section">
    <h3 id="lessonFormTitle">הוסף שיעור</h3>
    <div class="form-row">
      <div>
        <label>בחר תלמיד:</label>
        <select id="lessonStudent" onchange="updateLessonPrice(); refreshLessonView();">
          <option value="">בחר</option>
        </select>
      </div>
      <div>
        <label>נושא השיעור:</label>
        <input type="text" id="lessonTopic">
      </div>
      <div>
        <label>תאריך:</label>
        <input type="date" id="lessonDate">
      </div>
    </div>
    <div class="form-row">
      <div>
        <label>שעת התחלה:</label>
        <input type="time" id="lessonTime">
      </div>
      <div>
        <label>משך השיעור (דקות):</label>
        <input type="number" id="lessonDuration" value="60">
      </div>
      <div>
        <label>עלות:</label>
        <input type="number" id="lessonCost" value="0">
      </div>
    </div>
    <div class="form-row">
      <div>
        <label>דירוג (1-5):</label>
        <select id="lessonRating">
          <option value="">בחר דירוג</option>
          <option value="1">1 ⭐</option>
          <option value="2">2 ⭐⭐</option>
          <option value="3">3 ⭐⭐⭐</option>
          <option value="4">4 ⭐⭐⭐⭐</option>
          <option value="5">5 ⭐⭐⭐⭐⭐</option>
        </select>
      </div>
      <div>
        <label>
          <input type="checkbox" id="lessonPaid"> שולם
        </label>
      </div>
    </div>
    <div>
      <label>הערות:</label>
      <textarea id="lessonNotes" rows="3"></textarea>
    </div>
    <button class="btn btn-success" onclick="addLesson()" id="saveLessonBtn">שמור</button>
    <button class="btn btn-warning" onclick="cancelLessonEdit()" id="cancelLessonBtn" style="display:none;">ביטול</button>
  </div>
  
  <div id="lessonList"></div>
</div>

<!-- יומן -->
<div id="calendar" class="tab">
  <div class="form-section">
    <h3>יומן שיעורים</h3>
    <div style="text-align: center; margin: 20px 0;">
      <button class="btn btn-primary" onclick="changeMonth(-1)">← חודש קודם</button>
      <span id="currentMonth" style="margin: 0 20px; font-weight: bold; font-size: 18px;"></span>
      <button class="btn btn-primary" onclick="changeMonth(1)">חודש הבא →</button>
    </div>
  </div>
  
  <div class="form-section">
    <div id="calendarView" class="calendar"></div>
  </div>
</div>

<!-- תשלומים -->
<div id="payments" class="tab">
  <div class="form-section">
    <h3>תשלומים לפי תלמיד</h3>
    <select id="paymentStudent" onchange="refreshPaymentView()">
      <option value="">בחר</option>
    </select>
    <div id="paymentSummary"></div>
  </div>
  
  <div class="form-section">
    <h3>סיכום כלכלי</h3>
    <div id="financialSummary"></div>
  </div>
</div>

<!-- דוחות -->
<div id="reports" class="tab">
  <div style="text-align: center; margin: 20px 0;">
    <button class="btn btn-primary" onclick="exportToCSV()">ייצא ל-CSV</button>
    <button class="btn btn-success" onclick="printReport()">הדפס דוח</button>
    <button class="btn btn-warning" onclick="backupData()">גבה נתונים</button>
    <input type="file" id="importFile" style="display: none;" accept=".json" onchange="importData(event)">
    <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">ייבא נתונים</button>
    <button class="btn btn-danger" onclick="resetAllData()">מחק הכל</button>
  </div>
  
  <div class="form-section">
    <h3>דוח מפורט לתלמיד</h3>
    <select id="reportStudent" onchange="refreshReportView()">
      <option value="">בחר</option>
    </select>
    <div id="reportData"></div>
  </div>
</div>

<script>
// משתנים גלובליים
let students = [];
let lessons = [];
let currentEditingStudent = null;
let currentEditingLesson = null;
let currentDate = new Date();

// טעינה ראשונית
window.onload = function() {
  loadData(); // טען נתונים קודם
  initSampleData(); // רק אם אין נתונים שמורים
  renderDashboard();
  renderCalendar();
};

// מעבר בין טאבים
function showTab(tabId) {
  document.querySelectorAll(".tab").forEach(tab => tab.classList.remove("active"));
  document.getElementById(tabId).classList.add("active");
  
  if (tabId === 'dashboard') renderDashboard();
  if (tabId === 'calendar') renderCalendar();
  if (tabId === 'payments') refreshFinancialSummary();
}

// נושא כהה/בהיר
function toggleTheme() {
  const body = document.body;
  const currentTheme = body.getAttribute('data-theme');
  const newTheme = currentTheme === 'light' ? 'dark' : 'light';
  body.setAttribute('data-theme', newTheme);
  localStorage.setItem('theme', newTheme);
}

// הודעות
function showNotification(message, type = 'success') {
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.textContent = message;
  document.body.appendChild(notification);
  
  setTimeout(() => notification.classList.add('show'), 100);
  setTimeout(() => {
    notification.classList.remove('show');
    setTimeout(() => {
      if (document.body.contains(notification)) {
        document.body.removeChild(notification);
      }
    }, 300);
  }, 3000);
}

// שמירה וטעינה
function saveData() {
  try {
    const data = {
      students: students,
      lessons: lessons,
      lastUpdated: new Date().toISOString()
    };
    localStorage.setItem('lessonTrackerData', JSON.stringify(data));
    console.log("נתונים נשמרו בהצלחה");
  } catch (error) {
    console.error("שגיאה בשמירת נתונים:", error);
    showNotification("שגיאה בשמירת נתונים", "error");
  }
}

function loadData() {
  try {
    const savedData = localStorage.getItem('lessonTrackerData');
    if (savedData) {
      const data = JSON.parse(savedData);
      if (data.students && data.lessons) {
        students = data.students;
        lessons = data.lessons;
        console.log("נתונים נטענו מהזיכרון");
        showNotification("נתונים נטענו בהצלחה", "success");
      }
    }
    
    // טען נושא שמור
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) {
      document.body.setAttribute('data-theme', savedTheme);
    }
  } catch (error) {
    console.error("שגיאה בטעינת נתונים:", error);
    showNotification("שגיאה בטעינת נתונים", "error");
  }
  
  renderStudents();
  populateSelects();
}

// אתחול נתונים לדוגמה
function initSampleData() {
  // רק אם אין נתונים שמורים, נטען נתוני דוגמה
  const savedData = localStorage.getItem('lessonTrackerData');
  if (!savedData && students.length === 0) {
    students = [
      { name: 'יוסי כהן', age: 15, class: 'י"א', price: 120, discount: 10, phone: '050-1234567' },
      { name: 'שרה לוי', age: 14, class: 'ט"ו', price: 100, discount: 0, phone: '052-9876543' },
      { name: 'דני משה', age: 16, class: 'י"ב', price: 150, discount: 5, phone: '054-5555555' }
    ];
    
    lessons = [
      {
        id: 1,
        studentName: 'יוסי כהן',
        topic: 'אלגברה',
        date: '2025-07-25',
        time: '16:00',
        duration: 60,
        cost: 108,
        paid: true,
        rating: 4,
        notes: 'התקדמות טובה'
      },
      {
        id: 2,
        studentName: 'שרה לוי',
        topic: 'גיאומטריה',
        date: '2025-07-28',
        time: '17:30',
        duration: 90,
        cost: 100,
        paid: false,
        rating: 5,
        notes: 'מצוינת!'
      },
      {
        id: 3,
        studentName: 'דני משה',
        topic: 'חשבון דיפרנציאלי',
        date: '2025-08-01',
        time: '14:00',
        duration: 60,
        cost: 142,
        paid: true,
        rating: 3,
        notes: 'צריך להתרגל יותר'
      }
    ];
    
    // שמור את נתוני הדוגמה
    saveData();
    showNotification('נתוני דוגמה נטענו ונשמרו', 'success');
  }
}

// דשבורד
function renderDashboard() {
  const totalStudents = students.length;
  const totalLessons = lessons.length;
  const totalIncome = lessons.reduce((sum, l) => sum + (l.paid ? l.cost : 0), 0);
  const pendingPayments = lessons.reduce((sum, l) => sum + (!l.paid ? l.cost : 0), 0);
  const avgRating = lessons.filter(l => l.rating).length > 0 
    ? (lessons.filter(l => l.rating).reduce((sum, l) => sum + l.rating, 0) / lessons.filter(l => l.rating).length).toFixed(1)
    : 'N/A';

  const statsHTML = `
    <div class="stat-card">
      <div class="stat-number">${totalStudents}</div>
      <div>תלמידים פעילים</div>
    </div>
    <div class="stat-card">
      <div class="stat-number">${totalLessons}</div>
      <div>סה"כ שיעורים</div>
    </div>
    <div class="stat-card">
      <div class="stat-number">${totalIncome}₪</div>
      <div>הכנסות</div>
    </div>
    <div class="stat-card">
      <div class="stat-number">${pendingPayments}₪</div>
      <div>ממתין לתשלום</div>
    </div>
    <div class="stat-card">
      <div class="stat-number">${avgRating}</div>
      <div>דירוג ממוצע</div>
    </div>
  `;
  
  document.getElementById('dashboardStats').innerHTML = statsHTML;
  
  // פעילות אחרונה
  const recentLessons = lessons.slice(-5).reverse();
  const recentHTML = recentLessons.map(l => 
    `<div style="padding: 10px; border-bottom: 1px solid var(--border-color);">
      <strong>${l.studentName}</strong> - ${l.topic} (${l.date})
      <span style="float: left; color: ${l.paid ? 'green' : 'red'}">
        ${l.paid ? '✔ שולם' : '❌ לא שולם'}
      </span>
    </div>`
  ).join('');
  
  document.getElementById('recentActivity').innerHTML = recentHTML || '<p>אין פעילות עדיין</p>';
}

// ניהול תלמידים
function populateSelects() {
  const selectors = ['lessonStudent', 'paymentStudent', 'reportStudent'];
  selectors.forEach(id => {
    const select = document.getElementById(id);
    if (select) {
      select.innerHTML = '<option value="">בחר</option>';
      students.forEach(s => {
        const opt = document.createElement("option");
        opt.value = s.name;
        opt.textContent = s.name;
        select.appendChild(opt);
      });
    }
  });
}

function filterStudents() {
  const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
  const rows = document.querySelectorAll('#studentTable tr:not(:first-child)');
  
  rows.forEach(row => {
    const text = row.textContent.toLowerCase();
    row.style.display = text.includes(searchTerm) ? '' : 'none';
  });
}

function addStudent() {
  const name = document.getElementById("studentName").value.trim();
  const age = document.getElementById("studentAge").value;
  const studentClass = document.getElementById("studentClass").value.trim();
  const price = Number(document.getElementById("studentPrice").value) || 100;
  const discount = Number(document.getElementById("studentDiscount").value) || 0;
  const phone = document.getElementById("studentPhone").value.trim();
  
  if (!name) {
    showNotification("יש להזין שם תלמיד", "error");
    return;
  }
  
  if (currentEditingStudent) {
    currentEditingStudent.name = name;
    currentEditingStudent.age = age;
    currentEditingStudent.class = studentClass;
    currentEditingStudent.price = price;
    currentEditingStudent.discount = discount;
    currentEditingStudent.phone = phone;
    currentEditingStudent = null;
    document.getElementById("cancelStudentBtn").style.display = "none";
    showNotification("תלמיד עודכן בהצלחה");
  } else {
    const existing = students.find(s => s.name === name);
    if (existing) {
      existing.age = age;
      existing.class = studentClass;
      existing.price = price;
      existing.discount = discount;
      existing.phone = phone;
      showNotification("פרטי תלמיד עודכנו");
    } else {
      students.push({ name, age, class: studentClass, price, discount, phone });
      showNotification("תלמיד נוסף בהצלחה");
    }
  }
  
  saveData();
  renderStudents();
  populateSelects();
  clearStudentForm();
  renderDashboard();
}

function renderStudents() {
  const table = document.getElementById("studentTable");
  table.innerHTML = `
    <tr>
      <th>שם</th>
      <th>גיל</th>
      <th>כיתה</th>
      <th>מחיר ברירת מחדל</th>
      <th>הנחה</th>
      <th>טלפון</th>
      <th>פעולות</th>
    </tr>`;
    
  students.forEach(s => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${s.name}</td>
      <td>${s.age}</td>
      <td>${s.class}</td>
      <td>${s.price}₪</td>
      <td>${s.discount}%</td>
      <td>${s.phone || ''}</td>
      <td>
        <button class="btn btn-primary" onclick="editStudent('${s.name}')">ערוך</button>
        <button class="btn btn-danger" onclick="deleteStudent('${s.name}')">מחק</button>
      </td>`;
    table.appendChild(tr);
  });
}

function editStudent(name) {
  const s = students.find(st => st.name === name);
  if (!s) return;
  
  currentEditingStudent = s;
  document.getElementById("studentName").value = s.name;
  document.getElementById("studentAge").value = s.age;
  document.getElementById("studentClass").value = s.class;
  document.getElementById("studentPrice").value = s.price;
  document.getElementById("studentDiscount").value = s.discount || 0;
  document.getElementById("studentPhone").value = s.phone || '';
  document.getElementById("cancelStudentBtn").style.display = "inline-block";
}

function deleteStudent(name) {
  if (!confirm("האם אתה בטוח שברצונך למחוק את התלמיד? כל השיעורים שלו יימחקו גם כן.")) return;
  
  students = students.filter(s => s.name !== name);
  lessons = lessons.filter(l => l.studentName !== name);
  saveData();
  renderStudents();
  populateSelects();
  refreshLessonView();
  refreshPaymentView();
  refreshReportView();
  renderDashboard();
  showNotification("תלמיד נמחק", "warning");
}

function clearStudentForm() {
  document.getElementById("studentName").value = "";
  document.getElementById("studentAge").value = "";
  document.getElementById("studentClass").value = "";
  document.getElementById("studentPrice").value = "100";
  document.getElementById("studentDiscount").value = "0";
  document.getElementById("studentPhone").value = "";
}

function cancelStudentEdit() {
  currentEditingStudent = null;
  document.getElementById("cancelStudentBtn").style.display = "none";
  clearStudentForm();
}

// ניהול שיעורים
function updateLessonPrice() {
  const studentName = document.getElementById("lessonStudent").value;
  if (studentName) {
    const student = students.find(s => s.name === studentName);
    if (student) {
      const price = student.price || 100;
      const discount = student.discount || 0;
      const finalPrice = price * (1 - discount / 100);
      document.getElementById("lessonCost").value = Math.round(finalPrice);
    }
  }
}

function filterLessons() {
  const searchTerm = document.getElementById('lessonSearch').value.toLowerCase();
  const filter = document.getElementById('lessonFilter').value;
  const rows = document.querySelectorAll('#lessonList table tr:not(:first-child)');
  
  rows.forEach(row => {
    if (!row.dataset.lesson) return;
    
    const lesson = JSON.parse(row.dataset.lesson);
    const text = row.textContent.toLowerCase();
    
    let show = text.includes(searchTerm);
    
    if (filter && show) {
      if (filter === 'paid' && !lesson.paid) show = false;
      if (filter === 'unpaid' && lesson.paid) show = false;
      if (filter === 'overdue' && (lesson.paid || !isOverdue(lesson.date))) show = false;
    }
    
    row.style.display = show ? '' : 'none';
  });
}

function isOverdue(dateStr) {
  const lessonDate = new Date(dateStr);
  const today = new Date();
  const diffDays = (today - lessonDate) / (1000 * 60 * 60 * 24);
  return diffDays > 30; // שיעור נחשב באיחור אחרי 30 יום
}

function generateLessonId() {
  return Date.now() + Math.random();
}

function addLesson() {
  const studentName = document.getElementById("lessonStudent").value;
  if (!studentName) {
    showNotification("יש לבחור תלמיד", "error");
    return;
  }
  
  const topic = document.getElementById("lessonTopic").value.trim();
  const date = document.getElementById("lessonDate").value;
  const time = document.getElementById("lessonTime").value;
  const duration = Number(document.getElementById("lessonDuration").value) || 60;
  const notes = document.getElementById("lessonNotes").value.trim();
  const cost = Number(document.getElementById("lessonCost").value);
  const paid = document.getElementById("lessonPaid").checked;
  const rating = document.getElementById("lessonRating").value ? Number(document.getElementById("lessonRating").value) : null;
  
  if (!topic) {
    showNotification("יש להזין נושא שיעור", "error");
    return;
  }
  
  if (!date) {
    showNotification("יש להזין תאריך", "error");
    return;
  }
  
  if (currentEditingLesson) {
    currentEditingLesson.studentName = studentName;
    currentEditingLesson.topic = topic;
    currentEditingLesson.date = date;
    currentEditingLesson.time = time;
    currentEditingLesson.duration = duration;
    currentEditingLesson.notes = notes;
    currentEditingLesson.cost = cost;
    currentEditingLesson.paid = paid;
    currentEditingLesson.rating = rating;
    currentEditingLesson = null;
    
    document.getElementById("cancelLessonBtn").style.display = "none";
    document.getElementById("lessonFormTitle").textContent = "הוסף שיעור";
    document.getElementById("saveLessonBtn").textContent = "שמור";
    showNotification("שיעור עודכן בהצלחה");
  } else {
    lessons.push({ 
      id: generateLessonId(),
      studentName, 
      topic, 
      date,
      time,
      duration,
      notes, 
      cost, 
      paid,
      rating
    });
    showNotification("שיעור נוסף בהצלחה");
  }
  
  saveData();
  refreshLessonView();
  refreshPaymentView();
  refreshReportView();
  renderDashboard();
  renderCalendar();
  clearLessonForm();
}

function clearLessonForm() {
  document.getElementById("lessonTopic").value = "";
  document.getElementById("lessonDate").value = "";
  document.getElementById("lessonTime").value = "";
  document.getElementById("lessonDuration").value = "60";
  document.getElementById("lessonNotes").value = "";
  document.getElementById("lessonCost").value = "0";
  document.getElementById("lessonPaid").checked = false;
  document.getElementById("lessonRating").value = "";
}

function cancelLessonEdit() {
  currentEditingLesson = null;
  document.getElementById("cancelLessonBtn").style.display = "none";
  document.getElementById("lessonFormTitle").textContent = "הוסף שיעור";
  document.getElementById("saveLessonBtn").textContent = "שמור";
  clearLessonForm();
}

function editLesson(lessonId) {
  const lesson = lessons.find(l => l.id === lessonId);
  if (!lesson) return;
  
  currentEditingLesson = lesson;
  document.getElementById("lessonStudent").value = lesson.studentName;
  document.getElementById("lessonTopic").value = lesson.topic;
  document.getElementById("lessonDate").value = lesson.date;
  document.getElementById("lessonTime").value = lesson.time || '';
  document.getElementById("lessonDuration").value = lesson.duration || 60;
  document.getElementById("lessonNotes").value = lesson.notes;
  document.getElementById("lessonCost").value = lesson.cost;
  document.getElementById("lessonPaid").checked = lesson.paid;
  document.getElementById("lessonRating").value = lesson.rating || '';
  
  document.getElementById("cancelLessonBtn").style.display = "inline-block";
  document.getElementById("lessonFormTitle").textContent = "ערוך שיעור";
  document.getElementById("saveLessonBtn").textContent = "עדכן";
  
  document.querySelector('.form-section').scrollIntoView({ behavior: 'smooth' });
}

function deleteLesson(lessonId) {
  if (!confirm("האם אתה בטוח שברצונך למחוק את השיעור?")) return;
  
  lessons = lessons.filter(l => l.id !== lessonId);
  saveData();
  refreshLessonView();
  refreshPaymentView();
  refreshReportView();
  renderDashboard();
  renderCalendar();
  showNotification("שיעור נמחק", "warning");
}

function togglePayment(lessonId) {
  const lesson = lessons.find(l => l.id === lessonId);
  if (lesson) {
    lesson.paid = !lesson.paid;
    saveData();
    refreshLessonView();
    refreshPaymentView();
    refreshReportView();
    renderDashboard();
    showNotification(lesson.paid ? "סומן כשולם" : "בוטל סימון תשלום");
  }
}

function refreshLessonView() {
  const studentName = document.getElementById("lessonStudent").value;
  const container = document.getElementById("lessonList");
  container.innerHTML = "";
  
  if (!studentName) return;
  
  const list = lessons.filter(l => l.studentName === studentName);
  if (list.length === 0) {
    container.innerHTML = "<p>אין שיעורים</p>";
    return;
  }
  
  const table = document.createElement("table");
  table.innerHTML = `
    <tr>
      <th>נושא</th>
      <th>תאריך</th>
      <th>שעה</th>
      <th>משך</th>
      <th>הערות</th>
      <th>עלות</th>
      <th>דירוג</th>
      <th>סטטוס</th>
      <th>פעולות</th>
    </tr>`;
  
  list.forEach(l => {
    const tr = document.createElement("tr");
    const overdue = !l.paid && isOverdue(l.date);
    tr.className = l.paid ? 'paid' : (overdue ? 'overdue' : 'unpaid');
    tr.dataset.lesson = JSON.stringify(l);
    
    const ratingStars = l.rating ? '⭐'.repeat(l.rating) : 'לא דורג';
    
    tr.innerHTML = `
      <td>${l.topic}</td>
      <td>${l.date}</td>
      <td>${l.time || ''}</td>
      <td>${l.duration || 60} דק'</td>
      <td>${l.notes}</td>
      <td>${l.cost}₪</td>
      <td>${ratingStars}</td>
      <td>${l.paid ? "✔ שולם" : (overdue ? "⏰ באיחור" : "❌ לא שולם")}</td>
      <td>
        <button class="btn btn-primary" onclick="editLesson(${l.id})">ערוך</button>
        <button class="btn btn-warning" onclick="togglePayment(${l.id})">
          ${l.paid ? "בטל תשלום" : "סמן כשולם"}
        </button>
        <button class="btn btn-danger" onclick="deleteLesson(${l.id})">מחק</button>
      </td>`;
    table.appendChild(tr);
  });
  container.appendChild(table);
}

// יומן
function renderCalendar() {
  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();
  
  document.getElementById('currentMonth').textContent = 
    new Date(year, month).toLocaleDateString('he-IL', { year: 'numeric', month: 'long' });
  
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const startDate = new Date(firstDay);
  startDate.setDate(startDate.getDate() - firstDay.getDay());
  
  const calendar = document.getElementById('calendarView');
  calendar.innerHTML = '';
  
  // כותרות ימי השבוע
  const dayHeaders = ['ראש', 'שני', 'שלי', 'רבי', 'חמי', 'שיש', 'שבת'];
  dayHeaders.forEach(day => {
    const dayHeader = document.createElement('div');
    dayHeader.className = 'calendar-day';
    dayHeader.innerHTML = `<strong>${day}</strong>`;
    dayHeader.style.background = 'var(--primary-color)';
    dayHeader.style.color = 'white';
    dayHeader.style.textAlign = 'center';
    calendar.appendChild(dayHeader);
  });
  
  // ימי החודש
  for (let i = 0; i < 42; i++) {
    const date = new Date(startDate);
    date.setDate(startDate.getDate() + i);
    
    const dayElement = document.createElement('div');
    dayElement.className = 'calendar-day';
    
    const isCurrentMonth = date.getMonth() === month;
    if (!isCurrentMonth) {
      dayElement.style.opacity = '0.3';
    }
    
    const dateStr = date.toISOString().split('T')[0];
    const dayLessons = lessons.filter(l => l.date === dateStr);
    
    dayElement.innerHTML = `
      <div style="font-weight: bold; margin-bottom: 3px;">${date.getDate()}</div>
      ${dayLessons.map(l => 
        `<div class="calendar-lesson" title="${l.studentName} - ${l.topic}">
          ${l.time || ''} ${l.studentName.split(' ')[0]}
        </div>`
      ).join('')}
    `;
    
    calendar.appendChild(dayElement);
  }
}

function changeMonth(direction) {
  currentDate.setMonth(currentDate.getMonth() + direction);
  renderCalendar();
}

// תשלומים
function refreshPaymentView() {
  const studentName = document.getElementById("paymentStudent").value;
  const div = document.getElementById("paymentSummary");
  div.innerHTML = "";
  
  if (!studentName) return;
  
  const list = lessons.filter(l => l.studentName === studentName);
  const total = list.reduce((sum, l) => sum + l.cost, 0);
  const paid = list.filter(l => l.paid).reduce((sum, l) => sum + l.cost, 0);
  const unpaid = total - paid;
  const count = list.length;
  const paidCount = list.filter(l => l.paid).length;
  
  const progressPercent = total > 0 ? (paid / total) * 100 : 0;
  
  div.innerHTML = `
    <div style="background: var(--card-bg); padding: 20px; border-radius: 10px; margin-top: 15px;">
      <h4>סיכום תשלומים - ${studentName}</h4>
      <div class="progress-bar">
        <div class="progress-fill" style="width: ${progressPercent}%"></div>
      </div>
      <p><strong>סה"כ שיעורים:</strong> ${count} (שולמו: ${paidCount})</p>
      <p><strong>סה"כ לתשלום:</strong> ${total}₪</p>
      <p><strong>שולם:</strong> ${paid}₪</p>
      <p><strong>נותר לתשלום:</strong> ${unpaid}₪</p>
      <p><strong>אחוז תשלום:</strong> ${progressPercent.toFixed(1)}%</p>
    </div>`;
}

function refreshFinancialSummary() {
  const thisMonth = new Date().toISOString().slice(0, 7);
  const thisMonthLessons = lessons.filter(l => l.date.startsWith(thisMonth));
  const monthlyIncome = thisMonthLessons.reduce((sum, l) => sum + (l.paid ? l.cost : 0), 0);
  const monthlyPending = thisMonthLessons.reduce((sum, l) => sum + (!l.paid ? l.cost : 0), 0);
  
  const totalIncome = lessons.reduce((sum, l) => sum + (l.paid ? l.cost : 0), 0);
  const totalPending = lessons.reduce((sum, l) => sum + (!l.paid ? l.cost : 0), 0);
  
  const overduePayments = lessons.filter(l => !l.paid && isOverdue(l.date));
  const overdueAmount = overduePayments.reduce((sum, l) => sum + l.cost, 0);
  
  document.getElementById('financialSummary').innerHTML = `
    <div class="dashboard">
      <div class="stat-card">
        <div class="stat-number">${monthlyIncome}₪</div>
        <div>הכנסות החודש</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">${monthlyPending}₪</div>
        <div>ממתין החודש</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">${totalIncome}₪</div>
        <div>סה"כ הכנסות</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" style="color: var(--danger-color);">${overdueAmount}₪</div>
        <div>תשלומים באיחור (${overduePayments.length})</div>
      </div>
    </div>
  `;
}

// דוחות
function refreshReportView() {
  const studentName = document.getElementById("reportStudent").value;
  const div = document.getElementById("reportData");
  div.innerHTML = "";
  
  if (!studentName) return;
  
  const list = lessons.filter(l => l.studentName === studentName);
  if (list.length === 0) {
    div.innerHTML = "<p>אין נתונים להצגה</p>";
    return;
  }
  
  const student = students.find(s => s.name === studentName);
  const avgRating = list.filter(l => l.rating).length > 0
    ? (list.filter(l => l.rating).reduce((sum, l) => sum + l.rating, 0) / list.filter(l => l.rating).length).toFixed(1)
    : 'לא דורג';
  
  const summaryHTML = `
    <div class="stat-card" style="margin-bottom: 20px; text-align: right;">
      <h4>סיכום כללי - ${studentName}</h4>
      <p><strong>גיל:</strong> ${student?.age || 'לא צוין'}</p>
      <p><strong>כיתה:</strong> ${student?.class || 'לא צוין'}</p>
      <p><strong>טלפון:</strong> ${student?.phone || 'לא צוין'}</p>
      <p><strong>סה"כ שיעורים:</strong> ${list.length}</p>
      <p><strong>דירוג ממוצע:</strong> ${avgRating === 'לא דורג' ? avgRating : avgRating + ' ⭐'}</p>
      <p><strong>שיעור אחרון:</strong> ${list[list.length-1]?.date || 'אין'}</p>
    </div>
  `;
  
  const table = document.createElement("table");
  table.innerHTML = `
    <tr>
      <th>נושא</th>
      <th>תאריך</th>
      <th>שעה</th>
      <th>הערות</th>
      <th>עלות</th>
      <th>דירוג</th>
      <th>סטטוס</th>
    </tr>`;
  
  list.forEach(l => {
    const tr = document.createElement("tr");
    tr.className = l.paid ? 'paid' : (isOverdue(l.date) ? 'overdue' : 'unpaid');
    tr.innerHTML = `
      <td>${l.topic}</td>
      <td>${l.date}</td>
      <td>${l.time || ''}</td>
      <td>${l.notes}</td>
      <td>${l.cost}₪</td>
      <td>${l.rating ? '⭐'.repeat(l.rating) : 'לא דורג'}</td>
      <td>${l.paid ? "✔ שולם" : (isOverdue(l.date) ? "⏰ באיחור" : "❌ לא שולם")}</td>`;
    table.appendChild(tr);
  });
  
  div.innerHTML = summaryHTML;
  div.appendChild(table);
}

// ייצוא ואיצוא
function exportToCSV() {
  const csvContent = [
    ['תלמיד', 'נושא', 'תאריך', 'שעה', 'עלות', 'שולם', 'דירוג', 'הערות'],
    ...lessons.map(l => [
      l.studentName,
      l.topic,
      l.date,
      l.time || '',
      l.cost,
      l.paid ? 'כן' : 'לא',
      l.rating || '',
      l.notes
    ])
  ].map(row => row.join(',')).join('\n');
  
  const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `lessons_report_${new Date().toISOString().slice(0, 10)}.csv`;
  link.click();
  
  showNotification('דוח יוצא בהצלחה');
}

function printReport() {
  const studentName = document.getElementById("reportStudent").value;
  const reportContent = document.getElementById("reportData").innerHTML;
  
  const printWindow = window.open('', '_blank');
  printWindow.document.write(`
    <html dir="rtl">
      <head>
        <title>דוח שיעורים - ${studentName}</title>
        <style>
          body { font-family: Arial; direction: rtl; }
          table { width: 100%; border-collapse: collapse; }
          th, td { border: 1px solid #ccc; padding: 8px; text-align: right; }
          th { background: #f0f0f0; }
          .paid { background: #e8f5e8; }
          .unpaid { background: #ffeaea; }
          .overdue { background: #fff3cd; }
        </style>
      </head>
      <body>
        <h1>דוח שיעורים - ${studentName || 'כללי'}</h1>
        <p>תאריך: ${new Date().toLocaleDateString('he-IL')}</p>
        ${reportContent}
      </body>
    </html>
  `);
  
  printWindow.document.close();
  printWindow.print();
}

function backupData() {
  const data = {
    students,
    lessons,
    timestamp: new Date().toISOString()
  };
  
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `lesson_tracker_backup_${new Date().toISOString().slice(0, 10)}.json`;
  link.click();
  
  showNotification('גיבוי נוצר בהצלחה');
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      
      if (data.students && data.lessons) {
        if (confirm('האם אתה בטוח שברצונך לייבא נתונים? זה יחליף את כל הנתונים הקיימים!')) {
          students = data.students;
          lessons = data.lessons;
          saveData();
          
          // רענן את כל התצוגות
          renderStudents();
          populateSelects();
          renderDashboard();
          renderCalendar();
          refreshPaymentView();
          refreshReportView();
          refreshFinancialSummary();
          refreshLessonView();
          
          showNotification('נתונים יובאו בהצלחה', 'success');
        }
      } else {
        showNotification('קובץ גיבוי לא תקין', 'error');
      }
    } catch (error) {
      showNotification('שגיאה בקריאת קובץ הגיבוי', 'error');
      console.error('Import error:', error);
    }
  };
  
  reader.readAsText(file);
  event.target.value = ''; // איפוס הקלט
}

function resetAllData() {
  if (confirm('האם אתה בטוח שברצונך למחוק את כל הנתונים? פעולה זו לא ניתנת לביטול!')) {
    if (confirm('בטוח בטוח? כל התלמידים והשיעורים יימחקו!')) {
      students = [];
      lessons = [];
      localStorage.removeItem('lessonTrackerData');
      
      // רענן את כל התצוגות
      renderStudents();
      populateSelects();
      renderDashboard();
      renderCalendar();
      refreshPaymentView();
      refreshReportView();
      refreshFinancialSummary();
      refreshLessonView();
      
      showNotification('כל הנתונים נמחקו', 'warning');
    }
  }
}
</script>
</body>
</html>
